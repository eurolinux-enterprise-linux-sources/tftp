rhbz#917817

--- tftp-hpa-0.49/tftpd/tftpd.c	2015-11-18 12:56:41.120932908 +0100
+++ tftp-hpa-0.49-new/tftpd/tftpd.c	2015-11-18 13:03:41.490276841 +0100
@@ -980,14 +980,14 @@ int main(int argc, char **argv)
 
 static char *rewrite_access(char *, int, const char **);
 static int validate_access(char *, int, struct formats *, const char **);
-static void tftp_sendfile(struct formats *, struct tftphdr *, int);
+static void tftp_sendfile(struct formats *, struct tftphdr *, int, char *);
 static void tftp_recvfile(struct formats *, struct tftphdr *, int);
 
 struct formats {
     const char *f_mode;
     char *(*f_rewrite) (char *, int, const char **);
     int (*f_validate) (char *, int, struct formats *, const char **);
-    void (*f_send) (struct formats *, struct tftphdr *, int);
+    void (*f_send) (struct formats *, struct tftphdr *, int, char *);
     void (*f_recv) (struct formats *, struct tftphdr *, int);
     int f_convert;
 } formats[] = {
@@ -1052,6 +1052,8 @@ int tftp(struct tftphdr *tp, int size)
                 nak(EACCESS, errmsgptr);        /* File denied by mapping rule */
                 exit(0);
             }
+            ecode =
+                (*pf->f_validate) (filename, tp_opcode, pf, &errmsgptr);
             if (verbosity >= 1) {
                 tmp_p = (char *)inet_ntop(from.sa.sa_family, SOCKADDR_P(&from),
                                           tmpbuf, INET6_ADDRSTRLEN);
@@ -1070,9 +1072,13 @@ int tftp(struct tftphdr *tp, int size)
                            tp_opcode == WRQ ? "WRQ" : "RRQ",
                            tmp_p, origfilename,
                            filename);
+
+                if (ecode == 1) {
+                    syslog(LOG_NOTICE, "Client %s File not found %s\n",
+                           tmp_p,filename);
+                }
             }
-            ecode =
-                (*pf->f_validate) (filename, tp_opcode, pf, &errmsgptr);
+
             if (ecode) {
                 nak(ecode, errmsgptr);
                 exit(0);
@@ -1095,12 +1101,12 @@ int tftp(struct tftphdr *tp, int size)
         if (tp_opcode == WRQ)
             (*pf->f_recv) (pf, (struct tftphdr *)ackbuf, ap - ackbuf);
         else
-            (*pf->f_send) (pf, (struct tftphdr *)ackbuf, ap - ackbuf);
+            (*pf->f_send) (pf, (struct tftphdr *)ackbuf, ap - ackbuf, origfilename);
     } else {
         if (tp_opcode == WRQ)
             (*pf->f_recv) (pf, NULL, 0);
         else
-            (*pf->f_send) (pf, NULL, 0);
+            (*pf->f_send) (pf, NULL, 0, origfilename);
     }
     exit(0);                    /* Request completed */
 }
@@ -1464,7 +1470,7 @@ static int validate_access(char *filenam
 /*
  * Send the requested file.
  */
-static void tftp_sendfile(struct formats *pf, struct tftphdr *oap, int oacklen)
+ static void tftp_sendfile(struct formats *pf, struct tftphdr *oap, int oacklen, char *filename)
 {
     struct tftphdr *dp;
     struct tftphdr *ap;         /* ack packet */
@@ -1554,6 +1560,13 @@ static void tftp_sendfile(struct formats
         }
         block++;
     } while (size == segsize);
+    tmp_p = (char *)inet_ntop(from.sa.sa_family, SOCKADDR_P(&from),
+                              tmpbuf, INET6_ADDRSTRLEN);
+    if (!tmp_p) {
+        tmp_p = tmpbuf;
+        strcpy(tmpbuf, "???");
+    }
+    syslog(LOG_NOTICE, "Client %s finished %s", tmp_p, filename);
   abort:
     (void)fclose(file);
 }
